---
import Layout from "@/layouts/layout.astro";
import EpisodeCard from "@/components/astro/episode-card.astro";
import EpisodesFilters from "@/components/islands/episodes-filters";
import Typography from "@/components/typography";
import { getEpisodes } from "@/lib/payload";

const search = Astro.url.searchParams.get("search") ?? undefined;
const sort = Astro.url.searchParams.get("sort") ?? "-episodeNumber";

let episodes: Awaited<ReturnType<typeof getEpisodes>>["docs"] = [];
let error: string | null = null;

try {
  const result = await getEpisodes({ search, sort });
  episodes = result.docs;
} catch (e) {
  error = "Could not load episodes. Please try again later.";
  console.error(e);
}
---

<Layout title="All Episodes â€” Schnitzel Podcast">
  <main
    class="min-h-screen bg-primary-foreground px-4 pt-10 pb-20 sm:px-6 md:pt-14 lg:px-10.25"
  >
    <!-- Page header -->
    <div
      class="mb-10 flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
    >
      <Typography
        tag="h1"
        variant="h1"
        uppercase={true}
        className="text-secondary"
      >
        All Episodes
      </Typography>

      <EpisodesFilters
        initialSearch={search ?? ""}
        initialSort={sort}
        client:load
      />
    </div>

    <!-- Episodes list -->
    <section>
      {
        error ? (
          <p class="py-16 text-center text-muted-foreground">{error}</p>
        ) : episodes.length === 0 ? (
          <p class="py-16 text-center text-muted-foreground">
            {search
              ? `No episodes found for "${search}".`
              : "No episodes published yet."}
          </p>
        ) : (
          <div class="flex flex-col gap-10">
            {episodes.map(episode => (
              <EpisodeCard episode={episode} />
            ))}
          </div>
        )
      }
    </section>
  </main>
</Layout>
